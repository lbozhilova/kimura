#' Calculate \eqn{F(i-1, i+2, 2, x)}
#'
#' Use Gauss' contiguous relations to calculate the hypergeometric function
#' \eqn{F(i-1, i+2, 2, x)} needed for estimating the Kimura distribution.
#'
#' @param i positive integer.
#' @param x number in \eqn{(0; 1)}: the point at which the function is
#'   calculated.
#'
#' @return The value of \eqn{F(i-1, i+2, 2, x)}, calculated recursively.
#'
#' @references Wonnapinij, Passorn, Patrick F. Chinnery, and David C. Samuels.
#'   "The distribution of mitochondrial DNA heteroplasmy due to random genetic
#'   drift." The American Journal of Human Genetics 83.5 (2008): 582-593.
#'
#'   Hoang-Binh, D. "A program to compute exact hydrogenic radial integrals,
#'   oscillator strengths, and Einstein coefficients, for principal quantum
#'   numbers up to nâ‰ˆ 1000." Computer Physics Communications 166.3 (2005):
#'   191-196.
#' @export
#'
#' @examples
#' .hypgeo(5, .3)
.hypgeo <- function(i, x) {
  a <- 1 - i
  b <- i + 2
  c <- 2
  f0 <- 1
  f1 <- 1 - (b * x) / c
  if (i == 1)
    return(f0)
  if (i == 2)
    return(f1)
  f <- 0
  for (j in 2:(i-1)) {
    aa <- 1 - j
    f <- (aa * (1 - x) * (f1 - f0) + (aa + b * x - c) * f1) / (aa - c)
    f0 <- f1
    f1 <- f
  }
  f
}

#' Probability of allele loss
#'
#' Estimate the probability that an allele is lost due to random genetic drift.
#'
#' @param p number in \eqn{(0; 1)}: initial heteroplasmy.
#' @param b number in \eqn{(0; 1)}: drift parameter.
#'
#' @details The parameter \code{p} corresponds to the initial heteroplasmy, and
#'   therefore is also equal to the mean heteroplasmy after genetic drift.
#'
#'   The parameter \code{b} corresponds to the amount of drift, and is equal to
#'   \code{b = exp(-t/N_eff)}, where \code{t} denotes time and \code{N_eff}
#'   denotes effective sample size.
#'
#' @return The probability the allele is lost due to genetic drift.
#'
#' @references Wonnapinij, Passorn, Patrick F. Chinnery, and David C. Samuels.
#'   "The distribution of mitochondrial DNA heteroplasmy due to random genetic
#'   drift." The American Journal of Human Genetics 83.5 (2008): 582-593.
#'
#'   Kimura, Motoo. "Solution of a process of random genetic drift with a
#'   continuous model." Proceedings of the National Academy of Sciences of the
#'   United States of America 41.3 (1955): 144.
#' @export
#'
#' @examples
#' .f0(0.3, 0.5)
.f0 <- function(p, b) {
  q <- 1 - p
  N <- 250
  sum_terms <- numeric(N)
  i_coef <- p * q * (2 * (1:N) + 1) * c(-1, 1)
  b_coef <- b^choose(2:(N + 1), 2)
  q_hg <- .hypgeo(1, q)
  sum_terms[1] <- q_hg * i_coef[1] * b_coef[1]
  for (i in 2:N) {
    q_hg <- .hypgeo(i, q)
    sum_terms[i] <- q_hg * i_coef[i] * b_coef[i]
    if (abs(sum_terms[i]-sum_terms[i-1]) < 1e-4)
      break
  }
  if(abs(sum_terms[N - 1] - sum_terms[N]) > 1e-4)
    warning("Series not yet converged at N = 250.")
  max(q + sum(sum_terms[1:i]), 0)
}

#' Probability of fixing allele
#'
#' Estimate the probability that an allele is fixed (i.e. the wildtype is lost)
#' due to random genetic drift.
#'
#' @inheritParams .f0
#'
#' @details The parameter \code{p} corresponds to the initial heteroplasmy, and
#'   therefore is also equal to the mean heteroplasmy after genetic drift.
#'
#'   The parameter \code{b} corresponds to the amount of drift, and is equal to
#'   \code{b = exp(-t/N_eff)}, where \code{t} denotes time and \code{N_eff}
#'   denotes effective sample size.
#'
#' @return The probability the allele is fixed due to genetic drift.
#'
#' @references Wonnapinij, Passorn, Patrick F. Chinnery, and David C. Samuels.
#'   "The distribution of mitochondrial DNA heteroplasmy due to random genetic
#'   drift." The American Journal of Human Genetics 83.5 (2008): 582-593.
#'
#'   Kimura, Motoo. "Solution of a process of random genetic drift with a
#'   continuous model." Proceedings of the National Academy of Sciences of the
#'   United States of America 41.3 (1955): 144.
#' @export
#'
#' @examples
#' .f1(0.3, 0.5)
.f1 <- function(p, b) {
  q <- 1 - p
  N <- 250
  sum_terms <- numeric(N)
  i_coef <- p * q * (2 * (1:N) + 1) * c(-1, 1)
  b_coef <- b^choose(2:(N + 1), 2)
  p_hg <- .hypgeo(1, p)
  sum_terms[1] <- p_hg * i_coef[1] * b_coef[1]
  for (i in 2:N) {
    p_hg <- .hypgeo(i, p)
    sum_terms[i] <- p_hg * i_coef[i] * b_coef[i]
    if (abs(sum_terms[i]-sum_terms[i-1]) < 1e-4)
      break
  }
  if(abs(sum_terms[N - 1] - sum_terms[N]) > 1e-4)
    warning("Series not yet converged at N = 250.")
  max(p + sum(sum_terms[1:i]), 0)
}

#' Density of the Kimura distribution
#'
#' Estimate the probability density function at \code{x} for heteroplasmy under
#' no selection pressure.
#'
#' @param x number in \eqn{(0; 1)}: the point at which the density is
#'   calculated.
#' @inheritParams .f0
#'
#' @return The density of \eqn{Kimura(p, b)}, evaluated at \eqn{x}.
#'
#' @references Wonnapinij, Passorn, Patrick F. Chinnery, and David C. Samuels.
#'   "The distribution of mitochondrial DNA heteroplasmy due to random genetic
#'   drift." The American Journal of Human Genetics 83.5 (2008): 582-593.
#'
#'   Kimura, Motoo. "Solution of a process of random genetic drift with a
#'   continuous model." Proceedings of the National Academy of Sciences of the
#'   United States of America 41.3 (1955): 144.
#' @export
#'
#' @examples
#' .phi(0.2, 0.3, 0.5)
.phi <- function(x, p, b) {
  q <- 1 - p
  N <- 250
  sum_terms <- numeric(N)
  i_coef <- sapply(1:N, function(i) i * (i + 1) * (2 * i + 1))
  i_coef <- p * q * i_coef
  b_coef <- b^choose(2:(N + 1), 2)
  x_hg <- .hypgeo(1, x)
  p_hg <- .hypgeo(1, p)
  sum_terms[1] <- p_hg * x_hg * i_coef[1] * b_coef[1]
  for (i in 2:N) {
    p_hg <- .hypgeo(i, p)
    x_hg <- .hypgeo(i, x)
    sum_terms[i] <- p_hg * x_hg * i_coef[i] * b_coef[i]
    if (abs(sum_terms[i]-sum_terms[i-1]) < 1e-4)
      break
  }
  if(abs(sum_terms[N - 1] - sum_terms[N]) > 1e-4)
    warning("Series not yet converged at N = 250.")
  max(sum(sum_terms[1:i]), 0)
}

#' The Kimura distribution
#'
#' Estimates the Kimura probability density function.
#'
#' @inheritParams .phi
#'
#' @return The density of Kimura(p, d), evaluated at x. Note there is a fixed
#'   probability at both extremes of the distribution.
#' @export
#'
#' @examples
#' dkimura(0, 0.3, 0.5)
#' dkimura(0.2, 0.3, 0.5)
#' dkimura(1, 0.3, 0.5)
dkimura <- function(x, p, b) {
  if (x == 0)
    return(.f0(p, b))
  if (x == 1)
    return(.f1(p, b))
  .phi(x, p, b)
}

#' The Kimura distribution
#'
#' Estimates the Kimura cumulative distribution function.
#'
#' @inheritParams .phi
#'
#' @return The CDF of Kimura(p, d), evaluated at x.
#' @export
#'
#' @examples
#' pkimura(0, 0.3, 0.5)
#' pkimura(0.2, 0.3, 0.5)
#' pkimura(1, 0.3, 0.5)
pkimura <- function(x, p, b) {
  if (x == 0)
    return(.f0(p, b))
  if (x == 1)
    return(1)
  prob_loss <- .f0(p, b)
  dst <- seq(1e-4, x, 1e-4)
  if(dst[length(dst)] < x)
    dst <- c(dst, x)
  d <- length(dst)
  delta <- dst[d] - dst[d - 1]
  dst_y <- sapply(dst, function(x) .phi(x, p, b))
  prob_loss +
    1e-4 * .5 * (sum(dst_y[1:(d-1)]) + sum(dst_y[2:(d-2)])) +
    delta * .5 * (dst_y[d-1] + dst_y[d])
}

#' The Kimura distribution
#'
#' Generates from the Kimura distribution.
#'
#' @param n number of observations to generate.
#' @inheritParams .phi
#'
#' @return A vector of length n.
#' @export
#'
#' @examples
#' rkimura(10, 0.3, 0.5)
rkimura <- function(n, p, b) {
  x <- seq(0, 1, 1e-4)
  pdf_x <- sapply(x, function(x) dkimura(x, p, b))
  cdf_x <- cumsum(pdf_x * c(1, rep(1e-4, 10000)))
  cdf_x[10001] <- 1
  spl <- sample(c(0, 0.5, 1), n, replace = TRUE,
                prob = c(.f0(p, b), 1 - .f0(p, b) - .f1(p, b), .f1(p, b)))
  idx <- which(spl == 0.5)
  m <- length(idx)
  spl[idx] <- stats::approx(cdf_x, x, stats::runif(m, min = cdf_x[1]))$y
  spl
}
